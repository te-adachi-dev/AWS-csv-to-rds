AWSTemplateFormatVersion: '2010-09-09'
Description: 'ETL System - Database and Storage Stack (IAM Auth Enabled + Public Access)'

Parameters:
  ProjectName:
    Type: String
    Description: 'Project name for resource naming'

  DBMasterUsername:
    Type: String
    Description: 'RDS Master Username'

  DBMasterPassword:
    Type: String
    NoEcho: true
    Description: 'RDS Master Password'

  VPCId:
    Type: String
    Description: 'VPC ID from Network Stack'

  PrivateSubnet1Id:
    Type: String
    Description: 'Private Subnet 1 ID from Network Stack'

  PrivateSubnet2Id:
    Type: String
    Description: 'Private Subnet 2 ID from Network Stack'

  PublicSubnet1Id:
    Type: String
    Description: 'Public Subnet 1 ID from Network Stack'
    
  PublicSubnet2Id:
    Type: String
    Description: 'Public Subnet 2 ID from Network Stack'

  LambdaSecurityGroupId:
    Type: String
    Description: 'Lambda Security Group ID from Network Stack'

Resources:
  # RDS Subnet Group - パブリックサブネットを含める
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS with public access
      SubnetIds:
        - !Ref PublicSubnet1Id
        - !Ref PublicSubnet2Id
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-db-subnet-group-public'

  # RDS Security Group - 外部アクセス用に修正
  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS with public access
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroupId
          Description: PostgreSQL from Lambda
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 0.0.0.0/0
          Description: PostgreSQL from Internet (TEMPORARY FOR TESTING)
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-rds-sg-public'

  # RDS Instance - IAM認証有効化とパブリックアクセス設定
  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-pg-iam-test'
      DBInstanceClass: db.t3.micro
      Engine: postgres
      EngineVersion: '16.4'
      AllocatedStorage: 20
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Ref DBMasterPassword
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !GetAtt RDSSecurityGroup.GroupId
      # IAM認証の有効化
      EnableIAMDatabaseAuthentication: true
      # パブリックアクセスの有効化
      PubliclyAccessible: true
      BackupRetentionPeriod: 1
      PreferredBackupWindow: "03:00-04:00"
      PreferredMaintenanceWindow: "sun:04:00-sun:05:00"
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-rds-iam-enabled'

  # データ用S3バケット
  DataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-data-${AWS::AccountId}-iam-test'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-data-bucket'

Outputs:
  RDSInstanceId:
    Description: RDS Instance ID
    Value: !Ref RDSInstance
    Export:
      Name: !Sub '${ProjectName}-RDSInstanceId'

  RDSEndpoint:
    Description: RDS PostgreSQL Endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address
    Export:
      Name: !Sub '${ProjectName}-RDSEndpoint'

  RDSPort:
    Description: RDS PostgreSQL Port
    Value: !GetAtt RDSInstance.Endpoint.Port
    Export:
      Name: !Sub '${ProjectName}-RDSPort'

  RDSResourceId:
    Description: RDS Resource ID for IAM policy
    Value: !GetAtt RDSInstance.DbiResourceId
    Export:
      Name: !Sub '${ProjectName}-RDSResourceId'

  DataBucketName:
    Description: Name of the S3 bucket for CSV data and results
    Value: !Ref DataBucket
    Export:
      Name: !Sub '${ProjectName}-DataBucketName'

  DataBucketArn:
    Description: ARN of the S3 bucket for CSV data and results
    Value: !GetAtt DataBucket.Arn
    Export:
      Name: !Sub '${ProjectName}-DataBucketArn'

  DBSubnetGroupName:
    Description: DB Subnet Group Name
    Value: !Ref DBSubnetGroup
    Export:
      Name: !Sub '${ProjectName}-DBSubnetGroupName'